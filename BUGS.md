# Known Bugs in CppGraphIndex Test Suite

This document describes bugs found when running `python tests/run_tests.py`. The test suite has several issues related to schema mismatches, incorrect node type expectations, and property access errors.

## Schema Analysis Summary

After comparing the `KUZU_SCHEMA.md` documentation with the actual C++ implementation and test failures, the root cause is clear: **the tests were written based on the documented schema expectations, but the actual implementation generates different node type names than what the schema specifies**.

### Key Finding: Node Type Name Mismatch

**Schema Documentation** (KUZU_SCHEMA.md lines 388-394) shows:
- C++ methods should generate `CXXMethodDecl` nodes
- Classes should generate `CXXRecordDecl` nodes  
- Functions should generate `FunctionDecl` nodes

**Actual Implementation** (MakeIndex/ASTNodeProcessor.cpp:303) uses:
```cpp
return decl->getDeclKindName();  // Uses Clang's internal naming
```

**Clang's `getDeclKindName()` returns different names:**
- C++ methods → `CXXMethod` (not `CXXMethodDecl`)
- Classes → `CXXRecord` (not `CXXRecordDecl`)
- Functions → `Function` (not `FunctionDecl`)

This explains why tests fail - they expect the documented schema names but get Clang's internal names.

## Bug #1: Schema Property Mismatch - Type Table

### How to Reproduce
```bash
python tests/run_tests.py
```
Look for the error: `Binder exception: Variable t is not in scope.` in TestTypesTest.

### What is the Problem
The test code in `tests/test_types.py` attempts to access a `node_type` property on the `Type` table:
```cypher
MATCH (t:Type) WHERE t.node_type IS NOT NULL RETURN t.node_type
```

However, the `Type` table schema (defined in `MakeIndex/KuzuDatabase.cpp:213-221`) does not include a `node_type` property.

**Actual Type table properties:**
- `node_id` (INT64 PRIMARY KEY)
- `type_name` (STRING)
- `canonical_type` (STRING)
- `size_bytes` (INT64)
- `is_const` (BOOLEAN)
- `is_volatile` (BOOLEAN)
- `is_builtin` (BOOLEAN)

### Expected Behavior
The test should either:
1. Query properties that actually exist on the Type table, OR
2. The Type table schema should be updated to include `node_type` if needed

### Problem Source
This is a **test bug** - the test is incorrectly written and doesn't match the actual database schema.

---

## Bug #2: Schema Documentation vs Implementation Mismatch - Node Type Names

### How to Reproduce
```bash
python tests/run_tests.py
```
Look for the failure: `Should have method declarations: Expected at least 1 results, got 0` in TestInheritanceTest.

### What is the Problem
The test in `tests/test_inheritance.py` searches for nodes with type `CXXMethodDecl`:
```cypher
MATCH (a:ASTNode) WHERE a.node_type = 'CXXMethodDecl' RETURN a
```

However, the actual node type generated by MakeIndex is `CXXMethod`, not `CXXMethodDecl`.

**Root Cause Analysis:**
1. **KUZU_SCHEMA.md** documents that C++ methods should be `CXXMethodDecl` (line 393)
2. **Tests were written** based on this documented schema expectation
3. **Actual implementation** uses `decl->getDeclKindName()` which returns Clang's internal names
4. **Clang returns** `CXXMethod` for C++ method declarations, not `CXXMethodDecl`

**Evidence:**
- Database contains 7 `CXXMethod` nodes (actual)
- Database contains 0 `CXXMethodDecl` nodes (expected by schema/tests)
- Methods like `virtualMethod`, `nonVirtualMethod`, `getDerivedValue` are correctly captured as `CXXMethod`

### Expected Behavior
Either:
1. **Update the implementation** to use schema-compliant names (`CXXMethodDecl`), OR
2. **Update the schema documentation** to reflect Clang's actual names (`CXXMethod`), OR  
3. **Update the tests** to use the actual implementation names

### Problem Source
This is a **schema consistency bug** - there's a three-way mismatch between documentation, implementation, and tests.

---

## Bug #3: Property Access on Wrong Tables - raw_text

### How to Reproduce
```bash
python tests/run_tests.py
```
Look for errors like: `Binder exception: Cannot find property raw_text for n.` in TestTemplatesTest and TestDeclarationsTest.

### What is the Problem
Multiple tests attempt to access `raw_text` property on tables that don't have it:

1. **TemplateParameter table**: Test tries `n.raw_text` but TemplateParameter has these properties:
   - `parameter_kind`, `parameter_name`, `has_default_argument`, `default_argument_text`, `is_parameter_pack`

2. **Declaration table**: Test tries `d.raw_text` but Declaration doesn't have `raw_text`

3. **Type table**: Similar issue with accessing non-existent properties

**The `raw_text` property exists on the ASTNode table**, not on these specialized tables.

### Expected Behavior
Tests should either:
1. Join with ASTNode table to access `raw_text`: 
   ```cypher
   MATCH (d:Declaration), (a:ASTNode) WHERE d.node_id = a.node_id RETURN a.raw_text
   ```
2. Use the correct properties available on each table

### Problem Source
This is a **test bug** - tests are accessing properties on the wrong tables.

---

## Bug #4: Test File Expectations Mismatch

### How to Reproduce
```bash
python tests/run_tests.py
```
Look for warnings like: `Warning: Expected file test_inheritance.cpp not found in source files`

### What is the Problem
The tests expect to find multiple separate C++ files:
- `test_inheritance.cpp`
- `test_templates.cpp` 
- `test_namespaces.cpp`
- `test_control_flow.cpp`
- `test_expressions.cpp`
- `test_preprocessor.cpp`

However, the test suite actually processes only one file: `KuzuOutputTest/comprehensive_test_no_std.cpp`, which contains all the test code in a single file.

### Expected Behavior
Either:
1. Update tests to expect the single comprehensive file, OR
2. Split the comprehensive test file into separate files as the tests expect, OR
3. Update the test runner to use a compilation database that includes multiple files

### Problem Source
This is a **test configuration bug** - there's a mismatch between what the test runner processes and what the individual tests expect.

---

## Bug #5: Missing Preprocessor Data

### How to Reproduce
```bash
python tests/run_tests.py
```
Look at TestPreprocessorTest output showing 0 macro definitions found.

### What is the Problem
The test expects to find macro definitions like `PI`, `MAX_SIZE`, `DEBUG_MODE`, etc., but the database contains 0 macro definitions.

This could be because:
1. The comprehensive test file doesn't include macro definitions
2. MakeIndex isn't capturing preprocessor information correctly
3. The compilation database doesn't include preprocessor flags

### Expected Behavior
Either:
1. Add macro definitions to the test C++ file, OR
2. Fix MakeIndex to capture preprocessor information, OR
3. Update the test to reflect that preprocessor analysis isn't implemented

### Problem Source
This could be either a **code bug** (MakeIndex not capturing macros) or a **test bug** (expecting functionality that doesn't exist).

---

## Summary

**Test Failures:** 2 out of 10 tests fail
**Root Cause:** Primarily test bugs due to schema mismatches and incorrect expectations

**Immediate Fixes Needed:**
1. Update test queries to use correct node types (`CXXMethod` not `CXXMethodDecl`)
2. Fix property access to use correct tables (join with ASTNode for `raw_text`)
3. Remove or fix queries that access non-existent properties (`node_type` on Type table)
4. Align test expectations with actual file processing (single comprehensive file)

**Verification:**
The underlying MakeIndex tool appears to be working correctly - it successfully captures:
- 7 CXXMethod declarations (including virtual methods and overrides)
- 348 AST nodes total
- 128 declarations
- 47 types
- Proper inheritance relationships
- Control flow structures
- Expression analysis

The issues are in the test suite, not the core functionality.

---

## Detailed Schema Comparison Analysis

### Documentation vs Implementation Discrepancies

After thorough analysis of `KUZU_SCHEMA.md`, the C++ implementation, and test failures, here are the key discrepancies:

#### 1. Node Type Naming Convention Mismatch

| Entity Type | Schema Documentation | Actual Implementation | Test Expectation |
|-------------|---------------------|----------------------|------------------|
| C++ Methods | `CXXMethodDecl` | `CXXMethod` | `CXXMethodDecl` |
| C++ Classes | `CXXRecordDecl` | `CXXRecord` | `CXXRecordDecl` |
| Functions | `FunctionDecl` | `Function` | `FunctionDecl` |
| Variables | `VarDecl` | `Var` | `VarDecl` |
| Namespaces | `NamespaceDecl` | `Namespace` | `NamespaceDecl` |

**Root Cause:** The implementation uses Clang's `getDeclKindName()` which returns abbreviated names, while the schema documents full Clang AST class names.

#### 2. Property Schema Inconsistencies

| Table | Schema Says Has | Implementation Has | Tests Try to Access |
|-------|----------------|-------------------|-------------------|
| Type | `node_id`, `type_name`, etc. | ✓ Correct | `node_type` ❌ |
| Declaration | `node_id`, `name`, etc. | ✓ Correct | `raw_text` ❌ |
| TemplateParameter | `parameter_kind`, etc. | ✓ Correct | `raw_text` ❌ |

**Root Cause:** Tests incorrectly assume `raw_text` exists on specialized tables when it only exists on the base `ASTNode` table.

#### 3. Schema Documentation Accuracy Issues

The `KUZU_SCHEMA.md` file contains several inaccuracies:

1. **Line 393**: Claims methods generate `CXXMethodDecl` nodes, but implementation generates `CXXMethod`
2. **Query Examples (lines 423-436)**: Use `CXXMethodDecl` and `CXXRecordDecl` which don't exist in actual implementation
3. **Property Examples**: Some queries assume properties exist on wrong tables

### Recommendations for Fixing Schema Consistency

#### Option 1: Update Implementation to Match Schema (Recommended)
Modify `ASTNodeProcessor::extractNodeType()` to return full AST class names:
```cpp
auto ASTNodeProcessor::extractNodeType(const clang::Decl* decl) -> std::string {
    // Return full class name instead of abbreviated kind name
    return decl->getDeclKindName() + "Decl";  // CXXMethod -> CXXMethodDecl
}
```

**Pros:** 
- Makes implementation match documented schema
- Tests work without changes
- More descriptive node type names
- Consistent with Clang AST class naming

**Cons:** 
- Requires code change and testing

#### Option 2: Update Schema and Tests to Match Implementation
Update `KUZU_SCHEMA.md` and all tests to use actual implementation names (`CXXMethod`, `CXXRecord`, etc.).

**Pros:** 
- No code changes needed
- Reflects current reality

**Cons:** 
- Extensive documentation and test updates needed
- Less descriptive node type names

#### Option 3: Hybrid Approach
Keep current implementation but add mapping layer for backward compatibility and update documentation to clarify the naming convention.

### Impact Assessment

**Current State:**
- ✅ Core MakeIndex functionality works correctly
- ✅ Database schema structure is sound
- ✅ AST processing captures all expected information
- ❌ Node type names don't match documentation
- ❌ Tests fail due to naming mismatches
- ❌ Schema documentation is inconsistent with implementation

**Priority:** Medium - functionality works but consistency issues cause confusion and test failures.